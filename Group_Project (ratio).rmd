---
title: "Group Project"
author: "Wan Ting Hsu"
date: "2/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

## Prepare data for model
# Load packages
```{r}
library(dplyr)
library(tidyverse)
library(lubridate)
library(readr)
library(hrbrthemes)
library(bsts)
library(ggplot2)
library(patchwork)
```

#Read data (zikang edits)
```{r}

nypd <- read.csv("nypd.csv")
nypd <- nypd %>% mutate(CMPLNT_FR_DT = mdy(CMPLNT_FR_DT ))
nypd$CMPLNT_FR_DT<-as.Date(nypd$CMPLNT_FR_DT)  


new<- nypd %>% 
  filter(CMPLNT_FR_DT >= "2010-03-01") %>%
  dplyr::select(CMPLNT_FR_DT, VIC_RACE) %>%
  group_by(CMPLNT_FR_DT, VIC_RACE) %>%
  count(VIC_RACE)

new$CMPLNT_FR_DT <- format(as.Date(new$CMPLNT_FR_DT), "%Y-%m")
colnames(new)[1] = "date"
colnames(new)[2] = "race"
str_trim(new$race, side = "both")

new <- new[-which(new$race == ""), ]



```


#before & after covid

```{r}
#bc = 10 years period before covid 
bc <- new %>%
  filter(date <"2020-03") %>%
  group_by(date) %>%
  count(race) 

#ac = after covid from 2020-03 to 2021-12-31
ac <- new %>%
  filter(date >= "2020-03") %>%
  group_by(date) %>%
  count(race)
```



#pivot_wider
```{r}
ac <- ac %>% pivot_wider(names_from = race, values_from = n)
bc <- bc %>% pivot_wider(names_from = race, values_from = n)

ac[is.na(ac)] = 0
bc[is.na(bc)] = 0
```

#create asian/non-asian
```{r}
ac$non_asian <- rowSums(ac[,c("BLACK", "BLACK HISPANIC", "UNKNOWN", "WHITE", "WHITE HISPANIC", "AMERICAN INDIAN/ALASKAN NATIVE")])
bc$non_asian <- rowSums(bc[,c("BLACK", "BLACK HISPANIC", "UNKNOWN", "WHITE", "WHITE HISPANIC", "AMERICAN INDIAN/ALASKAN NATIVE")])
```

```{r}
ac <- ac %>% dplyr::select(date, `ASIAN / PACIFIC ISLANDER`, non_asian)
bc <- bc %>% dplyr::select(date, `ASIAN / PACIFIC ISLANDER`, non_asian)
```


#before covid correlation
```{r}
cor(bc$`ASIAN / PACIFIC ISLANDER`, bc$non_asian)

```

The result shows a 0.79 high correlation between asian hate crime and non-asian hate crime. We are confidence to derive the conclusion that other race hate crime is highly correlated with asian hate crime. With this in mind, we can want to use bsts time series model to predict after covid asian hate crime using other race hate crime and compare to actual asian hate crime data. 




## Time Series

#Asian/Non-asian Ratio


```{r}
ac$ratio = round(ac$`ASIAN / PACIFIC ISLANDER`/ac$non_asian,3)
bc$ratio = round(bc$`ASIAN / PACIFIC ISLANDER`/bc$non_asian,3)
```


#change dataframe to xts format

```{r}

library(xts)

ac$date<-as.yearmon(ac$date)
ac <- xts(ac$ratio, ac$date)
bc$date<-as.yearmon(bc$date)
bc <- xts(bc$ratio, bc$date)
  
colnames(ac)[1] = "ratio"
colnames(bc)[1] = "ratio"

```


#bsts model (bc ratio) 
```{r}
library(bsts)     # load the bsts package
library(zoo)

ss<- AddLocalLinearTrend(list(), bc$ratio)
ss <- AddSeasonal(ss, bc$ratio, nseasons = 12)
model1 <- bsts(bc$ratio,
               state.specification = ss,
               niter = 1000)
```


#plot bc ratio

Plot before covid 
```{r}
plot(model1)
plot(model1, "components")
plot(model1, "help")


```
#Predict using bc ratio

```{r}
pred1 <- predict(model1, horizon =  22)
plot(pred1, 
     font = 4,
     main = "BSTS Crime Ratios",
     par(bg = "#f7f7f7"),
     xlab = "Time", ylab = "Crime Ratio", 
     ylim = c(-0.2, 0.8), 
     plot.original = 60)
```

```{r}
plot(pred1, 
     font = 4,
     main = "BSTS Crime Ratios",
     par(bg = "#f7f7f7"),
     xlab = "Time", ylab = "Crime Ratio", 
     ylim = c(-0.2, 0.8), 
     plot.original = FALSE)
```


# ploting the actual ratio after-covid
```{r}
plot(ac,     
     font = 4,
     col="green",
     par= "white",
     main = "BSTS Crime Ratios",
     par(bg = "#f7f7f7"),
     xlab = "Time", ylab = "Crime Ratio", 
     ylim = c(-0.2, 0.8)
     )
```



#Combine plot ac & bc predtion
Here we combine the crime ratio of the after covid asian hate crime ratio prediction using before covid data and the actual after covid data to see if there is a difference. If we see a major difference, we can assume that covid might have some effects on asian hate crime. However, if the two graphs are really similar, then it indicates that covid had no effect on asian hate crime.


```{r}
pred_df <- data.frame(date = c("2020-03","2020-04", "2020-05", "2020-06","2020-07", "2020-08","2020-09", "2020-10","2020-11", "2020-12" , "2021-01", "2021-02", "2021-03", "2021-04", "2021-05", "2021-06", "2021-07", "2021-08", "2021-09", "2021-10", "2021-11", "2021-12"), ratio = pred1$mean)
pred_df$ratio = round(pred_df$ratio,3)

pred_df$date<-as.yearmon(pred_df$date)
pred_df <- xts(pred_df$ratio, pred_df$date)

```


```{r}

plot(ac,     
     font = 4,
     col="green",
     par= "white",
     main = "BSTS Crime Ratios",
     par(bg = "#f7f7f7"),
     xlab = "Time", ylab = "Crime Ratio", 
     ylim = c(-0.2, 0.8))

lines(pred_df, col = "red")
# Panels
plot.zoo(cbind(ac, pred_df))
# Overplotted
plot.zoo(cbind(ac, pred_df), 
         plot.type = "single", 
         col = c("red", "blue"),
         xlab = "Time", ylab = "Crime Ratio")
```




```{r}
predict(model1, horizon =  24)
```


#Quantified difference

```{r}

```










